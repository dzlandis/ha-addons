#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the Kiwix service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

# Declare variables
declare library_path
declare log_level
declare threads
declare search_limit
declare block_external_links
declare no_search_bar
declare no_library_button

# Get configuration options
library_path=$(bashio::config 'library_path')
log_level=$(bashio::config 'log_level')
threads=$(bashio::config 'threads')
search_limit=$(bashio::config 'search_limit')
block_external_links=$(bashio::config 'block_external_links')
no_search_bar=$(bashio::config 'no_search_bar')
no_library_button=$(bashio::config 'no_library_button')

# Set defaults
library_path=${library_path:-"/share/kiwix"}
port=8099
log_level=${log_level:-"info"}
threads=${threads:-4}
search_limit=${search_limit:-0}
block_external_links=${block_external_links:-false}
no_search_bar=${no_search_bar:-false}
no_library_button=${no_library_button:-false}

# Create library directory if it doesn't exist
if [ ! -d "${library_path}" ]; then
    bashio::log.info "Creating library directory: ${library_path}"
    mkdir -p "${library_path}"
fi

# Create a simple index.html if no ZIM files are found
if [ ! "$(ls -A ${library_path}/*.zim 2>/dev/null)" ]; then
    bashio::log.warning "No ZIM files found in ${library_path}"
    bashio::log.info "You can add ZIM files to the library path to start serving content"
    bashio::log.info "Download ZIM files from https://library.kiwix.org/"
    
    # Create a welcome page
    cat > /tmp/welcome.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Kiwix - Home Assistant Add-on</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; }
        .info { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to Kiwix Home Assistant Add-on</h1>
        <div class="warning">
            <strong>No content available!</strong><br>
            No ZIM files were found in your library directory.
        </div>
        <div class="info">
            <h3>How to add content:</h3>
            <ol>
                <li>Download ZIM files from <a href="https://library.kiwix.org/" target="_blank">library.kiwix.org</a></li>
                <li>Copy the ZIM files to your configured library path: <code>${library_path}</code></li>
                <li>Restart this add-on</li>
                <li>Your content will be available here!</li>
            </ol>
            <p><strong>Popular ZIM files:</strong></p>
            <ul>
                <li>Wikipedia (various languages)</li>
                <li>Wiktionary</li>
                <li>TED Talks</li>
                <li>Project Gutenberg</li>
                <li>Stack Overflow</li>
            </ul>
        </div>
    </div>
</body>
</html>
EOF
    
    # Start a simple HTTP server for the welcome page
    bashio::log.info "Starting welcome server on port ${port}"
    cd /tmp
    exec python3 -m http.server ${port} --bind 0.0.0.0
else
    # Start Kiwix server with ZIM files - direct ingress mode
    bashio::log.info "Starting Kiwix server on direct ingress port ${port}"
    bashio::log.info "Library path: ${library_path}"
    bashio::log.info "Log level: ${log_level}"
    bashio::log.info "Threads: ${threads}"
    bashio::log.info "Search limit: ${search_limit}"
    
    # Build array of ZIM files
    zim_files=()
    for zim_file in "${library_path}"/*.zim; do
        if [ -f "$zim_file" ]; then
            bashio::log.info "Adding ZIM file: $(basename "$zim_file")"
            zim_files+=("$zim_file")
        fi
    done
    
    # Check if we have any ZIM files
    if [ ${#zim_files[@]} -eq 0 ]; then
        bashio::log.error "No valid ZIM files found in ${library_path}"
        exit 1
    fi
    
    # Detect ingress path for proper URL generation
    ingress_path=""
    if bashio::var.has_value "$(bashio::addon.ingress_entry)"; then
        ingress_url=$(bashio::addon.ingress_entry)
        bashio::log.info "Full ingress URL detected: '${ingress_url}'"
        
        # Check if it's already just a path or a full URL
        if [[ "${ingress_url}" == http* ]]; then
            # Extract just the path part from the full URL
            # Example: https://homeassistant.local:8123/api/hassio_ingress/xyz/abc -> /api/hassio_ingress/xyz/abc
            ingress_path=$(echo "${ingress_url}" | sed 's|^https\?://[^/]*||')
            bashio::log.info "Extracted ingress path from full URL: '${ingress_path}'"
        else
            # It's already just the path
            ingress_path="${ingress_url}"
            bashio::log.info "Using ingress path as-is: '${ingress_path}'"
        fi
    else
        bashio::log.info "No ingress URL detected - running in direct access mode"
    fi
    
    # Build command arguments
    args=(
        "--port=${port}"
        "--address=0.0.0.0"
        "--threads=${threads}"
    )
    
    # Add URL root location if we have an ingress path
    if [ -n "${ingress_path}" ]; then
        # Clean up the ingress path to ensure it's valid
        cleaned_path=$(echo "${ingress_path}" | tr -d '\r\n' | sed 's/[[:space:]]*$//')
        bashio::log.info "Cleaned ingress path: '${cleaned_path}'"
        bashio::log.info "Original path length: ${#ingress_path}, cleaned length: ${#cleaned_path}"
        
        args+=("--urlRootLocation=${cleaned_path}")
        bashio::log.info "Added --urlRootLocation=${cleaned_path} to Kiwix arguments"
        bashio::log.info "Final kiwix-serve command will be: kiwix-serve ${args[*]} <zim_files>"
    else
        bashio::log.info "No ingress path - Kiwix will serve from root"
        bashio::log.info "Final kiwix-serve command will be: kiwix-serve ${args[*]} <zim_files>"
    fi
    
    bashio::log.info "Kiwix args: ${args[*]}"
    
    # Add optional arguments
    if [ "${search_limit}" -gt 0 ]; then
        args+=("--searchLimit=${search_limit}")
    fi
    
    if [ "${block_external_links}" = "true" ]; then
        args+=("--blockexternal")
    fi
    
    if [ "${no_search_bar}" = "true" ]; then
        args+=("--nosearchbar")
    fi
    
    if [ "${no_library_button}" = "true" ]; then
        args+=("--nolibrarybutton")
    fi
    
    # Execute kiwix-serve with all ZIM files
    bashio::log.info "Starting Kiwix server with ${#zim_files[@]} ZIM file(s)"
    exec /usr/local/bin/kiwix-serve "${args[@]}" "${zim_files[@]}"
fi
