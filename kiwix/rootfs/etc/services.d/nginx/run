#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Kiwix
# Runs nginx for ingress support
# ==============================================================================

# Create all directories nginx might need
mkdir -p /var/lib/nginx/tmp/client_body \
         /var/lib/nginx/tmp/proxy \
         /var/lib/nginx/tmp/fastcgi \
         /var/lib/nginx/tmp/uwsgi \
         /var/lib/nginx/tmp/scgi \
         /var/lib/nginx/logs \
         /var/log/nginx \
         /run/nginx \
         /tmp

# Replace ingress entry placeholder
sed -i "s|%%ingress_entry%%|$(bashio::addon.ingress_entry)|g" /etc/nginx/nginx.conf

# Wait for Kiwix to be available
while ! nc -z 127.0.0.1 8090; do
    bashio::log.info "Waiting for Kiwix to start..."
    sleep 2
done

bashio::log.info "Starting nginx for ingress support..."

# Start nginx directly (let it handle temp directories)
exec nginx
